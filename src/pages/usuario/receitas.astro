---
const title = 'BemComido - Minhas Receitas';
---
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <link rel="stylesheet" href="/src/styles/global.css" />
  </head>
  <body class="min-h-screen">
    <header class="w-full bg-brandRed text-white shadow-md">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
        <a href="/app" class="px-3 py-1 bg-[#b21f1f] rounded shadow-button">Home</a>
        <div class="mx-auto flex items-center gap-2 text-2xl font-logo">
          <span>BC</span>
          <span aria-hidden="true">‚òï</span>
        </div>
        <a href="/enviar-receita" class="px-3 py-1 bg-[#b21f1f] rounded shadow-button">Enviar Receita</a>
        <div class="flex items-center gap-2 ml-2">
          <span>Bem vindo, Usu√°rio</span>
          <span class="inline-block h-7 w-7 rounded-full bg-white text-brandRed grid place-items-center">üë§</span>
        </div>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-10">
      <h1 class="text-2xl text-brandBrown mb-4">Minhas Receitas</h1>

      <div id="recipesList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      <p id="recipesMsg" class="mt-4 text-sm"></p>
    </main>
  </body>
</html>
<script>
  const listEl = document.getElementById('recipesList');
  const msgEl = document.getElementById('recipesMsg');

  const mocked = [
    {
      nome: 'Bolo de Cenoura Cl√°ssico',
      tempoMedioMinutos: 45,
      rendimento: '8 por√ß√µes',
      nivelTecnica: 'FACIL'
    },
    {
      nome: 'Lasanha de Frango',
      tempoMedioMinutos: 60,
      rendimento: '6 por√ß√µes',
      nivelTecnica: 'MODERADO'
    },
    {
      nome: 'Risoto de Cogumelos',
      tempoMedioMinutos: 35,
      rendimento: '4 por√ß√µes',
      nivelTecnica: 'AVANCADO'
    },
    {
      nome: 'Torta de Lim√£o',
      tempoMedioMinutos: 50,
      rendimento: '10 por√ß√µes',
      nivelTecnica: 'FACIL'
    }
  ];

  function recipeCard(r) {
    const el = document.createElement('article');
    el.className = 'bg-white rounded-xl border border-black/60 shadow-sm p-4';
    el.innerHTML = `
      <div class="flex items-center gap-2 text-sm text-brandBrown mb-2">
        <span class="inline-block h-6 w-6 rounded-full bg-brandYellow grid place-items-center">üçΩÔ∏è</span>
        <span>${r.nome || 'Sem t√≠tulo'}</span>
      </div>
      ${r.imagemUrl ? `<img src="${r.imagemUrl}" alt="${r.nome}" class="w-full h-40 object-cover rounded-md mb-3" />` : ''}
      <div class="text-brandBrown space-y-1">
        <p><strong>Tempo:</strong> ${r.tempoMedioMinutos ?? '-'} min</p>
        <p><strong>Rendimento:</strong> ${r.rendimento ?? '-'}</p>
        <p><strong>N√≠vel:</strong> ${r.nivelTecnica ?? '-'}</p>
      </div>
      <div class="mt-3 flex justify-end">
        <button data-id="${r.id ?? ''}" class="edit-recipe px-3 py-1 bg-brandRed text-white rounded shadow-button">Editar</button>
      </div>
    `;
    return el;
  }

  async function loadRecipes() {
    const token = localStorage.getItem('authToken');
    // Render mocked immediately for a pleasant UI
    listEl.innerHTML = '';
    mocked.forEach(r => listEl.appendChild(recipeCard(r)));
    msgEl.textContent = '';

    if (!token) {
      // No auth; keep mocked content
      return;
    }
    try {
      // Attempt to load real ones and replace mocked
      const loadingNote = document.createElement('span');
      loadingNote.textContent = ' (carregando suas receitas...)';
      msgEl.appendChild(loadingNote);

      const res = await fetch('http://localhost:8080/recipes/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const body = await res.json().catch(() => []);
      if (!res.ok) throw new Error(body.message || 'Falha ao buscar receitas');

      const items = Array.isArray(body) ? body : [];
      if (items.length > 0) {
        listEl.innerHTML = '';
        items.forEach(r => listEl.appendChild(recipeCard(r)));
      }
    } catch (err) {
      // Keep mocked content; no extra message
      msgEl.textContent = '';
    }
  }

  // Delegate edit button clicks
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.edit-recipe');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    if (id) {
      window.location.href = `/usuario/receitas/editar/${id}`;
    } else {
      // Fallback for mocked items without id
      window.location.href = '/usuario/editar';
    }
  });

  loadRecipes();
</script>